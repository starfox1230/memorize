<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Memorize with User Filter - Night Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /*******************************************************************
     * NIGHT MODE STYLING
     * (Directly from your original index.html, with minor additions)
     *******************************************************************/

    /* CSS Variables for Night Mode */
    :root {
      --background-color: #121212;
      --container-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --secondary-text-color: #b0b0b0;
      --button-bg: #3a3a3a;
      --button-hover-bg: #505050;
      --button-color: #e0e0e0;
      --delete-button-bg: #ff4d4d;
      --delete-button-hover-bg: #ff6666;
      --border-color: #333333;
      --input-bg: #2c2c2c;
      --input-border: #444444;
      --select-bg: #2c2c2c;
      --select-border: #444444;
      --shadow-color: rgba(0, 0, 0, 0.5);
    }

    /* Basic Reset and Global Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 700px;
      margin: auto;
      background: var(--container-bg);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px var(--shadow-color);
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--text-color);
    }

    textarea {
      width: 100%;
      height: 120px;
      margin-bottom: 15px;
      padding: 15px;
      resize: vertical;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      background-color: var(--input-bg);
      color: var(--text-color);
      font-size: 16px;
      transition: background-color 0.3s, color 0.3s, border 0.3s;
    }

    textarea::placeholder {
      color: var(--secondary-text-color);
    }

    select, button, input[type="text"] {
      padding: 12px 20px;
      margin-right: 10px;
      border: 1px solid var(--select-border);
      border-radius: 6px;
      cursor: pointer;
      background-color: var(--select-bg);
      color: var(--text-color);
      font-size: 16px;
      transition: background-color 0.3s, border 0.3s, color 0.3s;
    }

    input[type="text"] {
      width: 100%;
      margin-bottom: 15px;
      background-color: var(--input-bg);
      border: 1px solid var(--input-border);
    }

    button {
      background-color: var(--button-bg);
      color: var(--button-color);
      border: none;
      transition: background-color 0.3s, color 0.3s;
    }

    button:hover {
      background-color: var(--button-hover-bg);
    }

    button:disabled {
      background-color: #555555;
      cursor: not-allowed;
    }

    .delete-btn {
      background-color: var(--delete-button-bg);
      color: #fff;
      border: none;
      transition: background-color 0.3s;
    }

    .delete-btn:hover {
      background-color: var(--delete-button-hover-bg);
    }

    .audio-list {
      margin-top: 30px;
    }

    .audio-item {
      display: flex;
      flex-direction: column; /* For toggling details easily */
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--input-bg);
      box-shadow: 0 2px 10px var(--shadow-color);
      transition: background-color 0.3s, box-shadow 0.3s, border 0.3s;
    }

    .audio-item .title-button {
      margin-bottom: 10px;
      font-size: 16px;
      background-color: var(--button-bg);
      color: var(--button-color);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
      padding: 12px 20px;
      text-align: left;
    }

    .audio-item .title-button:hover {
      background-color: var(--button-hover-bg);
    }

    .details-container {
      display: none; /* hidden by default, toggled by clicking the title button */
      margin-top: 10px;
    }

    .details-container audio {
      width: 100%;
      background-color: var(--background-color);
      border-radius: 4px;
      outline: none;
      margin-bottom: 10px;
    }

    .details-container .audio-info {
      font-size: 16px;
      color: var(--text-color);
      margin-bottom: 10px;
    }

    /* Responsive */
    @media (max-width: 600px) {
      select, button, input[type="text"], textarea {
        width: 100%;
        margin-bottom: 10px;
        margin-right: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Memorize (User Filter) - Night Mode</h1>
    
    <!-- User Input -->
    <input
      type="text"
      id="user-input"
      placeholder="Enter user name or ID (for storing and filtering)"
    />

    <!-- Title Input -->
    <input
      type="text"
      id="title-input"
      placeholder="Enter title here..."
    />

    <!-- Text Input -->
    <textarea
      id="text-input"
      placeholder="Enter text here..."
    ></textarea>

    <!-- Voice Selector -->
    <select id="voice-select">
      <option value="echo">Echo</option>
      <option value="alloy" selected>Alloy</option>
      <option value="fable">Fable</option>
      <option value="onyx">Onyx</option>
      <option value="nova">Nova</option>
      <option value="shimmer">Shimmer</option>
    </select>

    <!-- Generate Button -->
    <button id="generate-btn">Generate Audio</button>

    <!-- Filter Button -->
    <button id="filter-btn">Filter By User</button>

    <!-- Audio List -->
    <div class="audio-list" id="audio-list">
      <h2>Generated Audios</h2>
      <!-- Dynamically populated here -->
    </div>
  </div>

  <script>
    /****************************************************************
     * FRONT-END LOGIC FOR USER-BASED FILTERING + NIGHT MODE
     ****************************************************************/

    const userInput   = document.getElementById('user-input');
    const titleInput  = document.getElementById('title-input');
    const textInput   = document.getElementById('text-input');
    const voiceSelect = document.getElementById('voice-select');
    const generateBtn = document.getElementById('generate-btn');
    const filterBtn   = document.getElementById('filter-btn');
    const audioList   = document.getElementById('audio-list');

    // IMPORTANT: Replace with your actual backend URL
    const BACKEND_URL = 'https://memorize-backend-lf3t.onrender.com'; 

    // Keep track of last audio element the user interacted with
    let lastPlayedAudio = null;

    // ---------------------------------------------------
    //  1) Generate Audio
    // ---------------------------------------------------
    generateBtn.addEventListener('click', async () => {
      const user  = userInput.value.trim();
      const title = titleInput.value.trim();
      const text  = textInput.value.trim();
      const voice = voiceSelect.value;

      if (!user) {
        alert('Please enter a user name or ID.');
        return;
      }
      if (!title || !text) {
        alert('Please enter both a title and some text.');
        return;
      }

      try {
        generateBtn.disabled = true;
        generateBtn.innerText = 'Generating...';

        // POST /generate-audio
        const response = await fetch(`${BACKEND_URL}/generate-audio`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, title, text, voice }),
        });

        const data = await response.json();
        if (response.ok) {
          alert('Audio generated successfully!');
          titleInput.value = '';
          textInput.value = '';
          // After generating, fetch audios for this user
          fetchAudios(user);
        } else {
          alert(`Error: ${data.error}`);
        }
      } catch (error) {
        console.error('Error generating audio:', error);
        alert('Failed to generate audio.');
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerText = 'Generate Audio';
      }
    });

    // ---------------------------------------------------
    //  2) Filter By User
    // ---------------------------------------------------
    filterBtn.addEventListener('click', () => {
      const user = userInput.value.trim();
      // If user is empty, fetch all
      if (user.length === 0) {
        fetchAudios(null);
      } else {
        fetchAudios(user);
      }
    });

    // ---------------------------------------------------
    //  3) Fetch Audios (GET /audios)
    //     - If userParam provided, we append ?user=<userParam>
    //     - Otherwise fetch all
    // ---------------------------------------------------
    async function fetchAudios(userParam) {
      try {
        let url = `${BACKEND_URL}/audios`;
        if (userParam) {
          url += `?user=${encodeURIComponent(userParam)}`;
        }

        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const audios = await response.json();
        // Clear the list
        audioList.innerHTML = '<h2>Generated Audios</h2>';

        // Render each audio
        audios.forEach((audio) => {
          const audioItem = document.createElement('div');
          audioItem.className = 'audio-item';

          // Title button
          const titleButton = document.createElement('button');
          titleButton.className = 'title-button';
          // Display user + title
          titleButton.textContent = `${audio.user}: ${audio.title}`;

          // Details container (hidden by default)
          const detailsContainer = document.createElement('div');
          detailsContainer.className = 'details-container';

          // Audio element
          const audioElement = document.createElement('audio');
          audioElement.controls = true;
          audioElement.src = audio.url;
          audioElement.loop = true; // optional

          // Event listeners to track lastPlayedAudio
          audioElement.addEventListener('play',   () => { lastPlayedAudio = audioElement; });
          audioElement.addEventListener('pause',  () => { lastPlayedAudio = audioElement; });
          audioElement.addEventListener('seeked', () => { lastPlayedAudio = audioElement; });
          audioElement.addEventListener('ended',  () => { lastPlayedAudio = audioElement; });

          // Audio info
          const info = document.createElement('div');
          info.className = 'audio-info';
          const timestamp = audio.timestamp
            ? new Date(audio.timestamp.seconds * 1000).toLocaleString()
            : 'N/A';
          info.textContent = `Text: ${audio.text} | Voice: ${audio.voice} | Timestamp: ${timestamp}`;

          // Delete button
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', () => deleteAudio(audio.id));

          // Append them together
          detailsContainer.appendChild(audioElement);
          detailsContainer.appendChild(info);
          detailsContainer.appendChild(deleteBtn);

          // Toggle details on title click
          titleButton.addEventListener('click', () => {
            if (detailsContainer.style.display === 'none') {
              detailsContainer.style.display = 'block';
            } else {
              detailsContainer.style.display = 'none';
            }
          });

          // Put them in audio item
          audioItem.appendChild(titleButton);
          audioItem.appendChild(detailsContainer);

          // Finally, append to audio-list
          audioList.appendChild(audioItem);
        });
      } catch (error) {
        console.error('Error fetching audios:', error);
        alert('Failed to fetch audios.');
      }
    }

    // ---------------------------------------------------
    //  4) Delete Audio
    // ---------------------------------------------------
    async function deleteAudio(id) {
      if (!confirm('Are you sure you want to delete this audio?')) return;
      try {
        const response = await fetch(`${BACKEND_URL}/delete-audio`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id }),
        });

        const data = await response.json();
        if (response.ok) {
          alert('Audio deleted successfully!');
          // Refresh the list with current user param
          filterBtn.click();
        } else {
          alert(`Error: ${data.error}`);
        }
      } catch (error) {
        console.error('Error deleting audio:', error);
        alert('Failed to delete audio.');
      }
    }

    // ---------------------------------------------------
    //  5) Keyboard Shortcuts (left/right/space)
    // ---------------------------------------------------
    document.addEventListener('keydown', (event) => {
      if (!lastPlayedAudio) return;
      const key = event.key;
      switch (key) {
        case 'ArrowLeft':
          event.preventDefault();
          lastPlayedAudio.currentTime = Math.max(0, lastPlayedAudio.currentTime - 10);
          break;
        case 'ArrowRight':
          event.preventDefault();
          lastPlayedAudio.currentTime = Math.min(
            lastPlayedAudio.duration,
            lastPlayedAudio.currentTime + 10
          );
          break;
        case ' ':
        case 'Spacebar':
          event.preventDefault();
          if (lastPlayedAudio.paused) {
            lastPlayedAudio.play();
          } else {
            lastPlayedAudio.pause();
          }
          break;
        default:
          // no-op
          break;
      }
    });

    // ---------------------------------------------------
    //  On Page Load: fetch all audios (no user)
    // ---------------------------------------------------
    window.addEventListener('load', () => {
      fetchAudios(null); 
    });
  </script>
</body>
</html>
