<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Memorize with User Filter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* Reuse your night mode styles, truncated here for brevity. */
    .input-field { 
      width: 100%; 
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Memorize (User Filter Example)</h1>

    <!-- A simple user input/selector -->
    <input
      type="text"
      id="user-input"
      class="input-field"
      placeholder="User name or ID"
    />

    <!-- Title -->
    <input
      type="text"
      id="title-input"
      class="input-field"
      placeholder="Title for this audio"
    />

    <!-- Text -->
    <textarea
      id="text-input"
      class="input-field"
      placeholder="Enter text to convert to speech..."
    ></textarea>

    <!-- Voice -->
    <select id="voice-select" class="input-field">
      <option value="alloy">Alloy</option>
      <option value="echo">Echo</option>
      <option value="fable">Fable</option>
      <!-- etc. -->
    </select>

    <button id="generate-btn">Generate Audio</button>

    <!-- Filter button (optional) -->
    <button id="filter-btn">Filter By User</button>

    <div id="audio-list">
      <h2>Generated Audios</h2>
      <!-- Populated dynamically -->
    </div>
  </div>

  <script>
    const userInput   = document.getElementById('user-input');
    const titleInput  = document.getElementById('title-input');
    const textInput   = document.getElementById('text-input');
    const voiceSelect = document.getElementById('voice-select');
    const generateBtn = document.getElementById('generate-btn');
    const filterBtn   = document.getElementById('filter-btn');
    const audioList   = document.getElementById('audio-list');

    // Replace with your actual backend URL
    const BACKEND_URL = 'https://YOUR-BACKEND-URL.com';

    let lastPlayedAudio = null;

    // 1) Generate Audio
    generateBtn.addEventListener('click', async () => {
      const user  = userInput.value.trim();
      const title = titleInput.value.trim();
      const text  = textInput.value.trim();
      const voice = voiceSelect.value;

      if (!user) {
        return alert('Please enter a user name or ID.');
      }
      if (!title || !text) {
        return alert('Please enter a title and some text.');
      }

      try {
        generateBtn.disabled = true;
        generateBtn.innerText = 'Generating...';

        const resp = await fetch(`${BACKEND_URL}/generate-audio`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, title, text, voice }),
        });
        const data = await resp.json();

        if (resp.ok) {
          alert('Audio generated successfully!');
          titleInput.value = '';
          textInput.value  = '';
          // Refresh the list, but let's keep the user filter
          fetchAudios(user);
        } else {
          alert(`Error: ${data.error}`);
        }
      } catch (err) {
        console.error(err);
        alert('Failed to generate audio.');
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerText = 'Generate Audio';
      }
    });

    // 2) Filter by user
    filterBtn.addEventListener('click', () => {
      const user = userInput.value.trim();
      // If user is blank, fetch all
      fetchAudios(user || null);
    });

    // 3) Fetch Audios
    async function fetchAudios(userParam) {
      try {
        let url = `${BACKEND_URL}/audios`;
        if (userParam) {
          // pass as query string: /audios?user=someUser
          url += `?user=${encodeURIComponent(userParam)}`;
        }
        const resp = await fetch(url);
        const audios = await resp.json();

        audioList.innerHTML = '<h2>Generated Audios</h2>';

        audios.forEach(audio => {
          const audioItem = document.createElement('div');
          audioItem.className = 'audio-item';

          // Title button
          const titleBtn = document.createElement('button');
          titleBtn.textContent = `${audio.user}: ${audio.title}`;
          titleBtn.addEventListener('click', () => {
            details.style.display = (details.style.display === 'none') ? 'block' : 'none';
          });

          // Hidden details
          const details = document.createElement('div');
          details.style.display = 'none';
          details.style.marginTop = '10px';

          const audioElement = document.createElement('audio');
          audioElement.controls = true;
          audioElement.src = audio.url;

          audioElement.addEventListener('play',   () => { lastPlayedAudio = audioElement; });
          audioElement.addEventListener('pause',  () => { lastPlayedAudio = audioElement; });
          audioElement.addEventListener('seeked', () => { lastPlayedAudio = audioElement; });
          audioElement.addEventListener('ended',  () => { lastPlayedAudio = audioElement; });

          const info = document.createElement('div');
          const timeString = audio.timestamp
            ? new Date(audio.timestamp.seconds * 1000).toLocaleString()
            : 'N/A';
          info.textContent = `Text: ${audio.text} | Voice: ${audio.voice} | ${timeString}`;

          const delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', () => deleteAudio(audio.id));

          details.appendChild(audioElement);
          details.appendChild(info);
          details.appendChild(delBtn);

          audioItem.appendChild(titleBtn);
          audioItem.appendChild(details);

          audioList.appendChild(audioItem);
        });
      } catch (err) {
        console.error(err);
        alert('Failed to fetch audios.');
      }
    }

    // 4) Delete Audio
    async function deleteAudio(id) {
      if (!confirm('Are you sure you want to delete this audio?')) return;
      try {
        const resp = await fetch(`${BACKEND_URL}/delete-audio`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id }),
        });
        const data = await resp.json();
        if (resp.ok) {
          alert('Audio deleted successfully.');
          // Refresh
          filterBtn.click();
        } else {
          alert(`Error: ${data.error}`);
        }
      } catch (err) {
        console.error(err);
        alert('Failed to delete audio.');
      }
    }

    // 5) Keyboard Shortcuts
    document.addEventListener('keydown', function (event) {
      if (!lastPlayedAudio) return;
      const key = event.key;
      switch (key) {
        case 'ArrowLeft':
          event.preventDefault();
          lastPlayedAudio.currentTime = Math.max(0, lastPlayedAudio.currentTime - 10);
          break;
        case 'ArrowRight':
          event.preventDefault();
          lastPlayedAudio.currentTime = Math.min(
            lastPlayedAudio.duration,
            lastPlayedAudio.currentTime + 10
          );
          break;
        case ' ':
        case 'Spacebar':
          event.preventDefault();
          if (lastPlayedAudio.paused) {
            lastPlayedAudio.play();
          } else {
            lastPlayedAudio.pause();
          }
          break;
      }
    });

    // On page load, fetch everything (all users)
    window.onload = () => fetchAudios();
  </script>
</body>
</html>
